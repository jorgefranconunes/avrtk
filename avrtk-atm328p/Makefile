# -*- mode: makefile-gmake; -*-
###########################################################################
#
# Copyright (c) 2014 Jorge Nunes, All Rights Reserved.
#
###########################################################################

B_PROJ_ROOT = ..

include $(B_PROJ_ROOT)/make/avrtk.make


B_PROJ = avrtk-atm328p

AVRTK_ARCH = atmega328p





#
# The main sources of this module, to be compiled with AVR-GCC.
#

B_SOURCESET := MAIN

B_MAIN_CC_FLAGS = \
	$(B_CC_FLAGS) \
	-I $(B_PROJ_ROOT)/avrtk-core/src/main/c

B_MAIN_C_SOURCES = \
	avrtk/sys/atm328p/Atm328pTaskService.c \
	avrtk/sys/atm328p/Atm328pTickSource.c

include $(B_PROJ_ROOT)/make/compile.make





#
# The core library sources, to be compiled with AVR-GCC
#

include $(B_PROJ_ROOT)/avrtk-core/avrtk-core.make

B_SOURCESET := AVRTKCORE

B_AVRTKCORE_C_SOURCES = $(AVRTK_CORE_C_SOURCES)
B_AVRTKCORE_C_SRCDIR  = $(B_PROJ_ROOT)/avrtk-core/src/main/c
B_AVRTKCORE_CC        = $(B_CC)
B_AVRTKCORE_CC_FLAGS  = $(B_CC_FLAGS)

include $(B_PROJ_ROOT)/make/compile.make





#
# In this section we define the rules to create the avrtk library
# inside the project "lib" directory. That library is generated by
# merging the contents of core lib and the atmega328p specific lib.
#

LIB_BASENAME = libavrtk-$(B_PROJ_VERSION)-$(AVRTK_ARCH).a
LIB_TARGET   = $(B_PROJ_ROOT)/lib/$(LIB_BASENAME)
LIB_ALL_OBJS = $(B_MAIN_ALL_OBJS) $(B_AVRTKCORE_ALL_OBJS)

all :: $(LIB_TARGET)

check ::

clean ::
	$(B_DELETE) $(LIB_TARGET)
	$(B_DELETE) $(B_TARGET_DIR)

$(LIB_TARGET) : $(LIB_ALL_OBJS)
	$(B_AR) cru $@ $?
	$(B_RANLIB) $@


